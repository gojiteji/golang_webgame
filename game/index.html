<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.2.4/pixi.min.js"></script></head>
<body>
<div id="pixiview"></div>
<script>
    const app = new PIXI.Application({
        width: 400, height: 300, backgroundColor: 0x2f4f4f, resolution: window.devicePixelRatio || 1,
    });
    document.body.appendChild(app.view);

    var home1 = new PIXI.Graphics();
    home1.beginFill(0xdeb887);
    home1.lineStyle(5, 0xd2b48c);
    home1.drawCircle(60, 150, 50);
    app.stage.addChild(home1);

    var home1tx = PIXI.Texture.from('./images/item/home1.png');
    var home1sp = new PIXI.Sprite(home1tx);
    home1sp.width=home1sp.width/15;
    home1sp.height=home1sp.height/15;
    home1sp.anchor.set(0.5,0.5);
    home1sp.x = 60;
    home1sp.y = 145;
    home1sp.interactive = true;
    app.stage.addChild(home1sp);

    var home2 = new PIXI.Graphics();
    home2.beginFill(0xdeb887);
    home2.lineStyle(5, 0xd2b48c);
    home2.drawCircle(340, 150, 50);
    app.stage.addChild(home2);

    var home2tx = PIXI.Texture.from('./images/item/home2.png');
    var home2sp = new PIXI.Sprite(home2tx);
    home2sp.width=home2sp.width/15;
    home2sp.height=home2sp.height/15;
    home2sp.anchor.set(0.5,0.5);
    home2sp.x = 340;
    home2sp.y = 145;
    home2sp.interactive = true;
    app.stage.addChild(home2sp);



    // Create a new texture
    var glass = PIXI.Texture.from('./images/item/glass.png');
    for (i=0;i<20;i++) {
        var glasssprite = new PIXI.Sprite(glass);
        seed=Math.random()
        glasssprite.width = glasssprite.width / 50;
        glasssprite.height = glasssprite.height / 50;
        glasssprite.anchor.set(0.5, 0.5);
        glasssprite.x = Math.random()*380;
        glasssprite.y = Math.random()*260;
        glasssprite.interactive = true;
        app.stage.addChild(glasssprite);
    }



    function speed(a,b){
        c=a-b>0?1:-1;
        if(a-b<1 && a-b>0){
            c=0
        }
        return c
    }

    personlist=[]
    class  Passenger{
        constructor(x,y,vx,vy) {

            this.x = x;
            this.y = y;
            this.vx = vx;
            this.vy = vy;

            this.index = Math.floor(Math.random() * 11)
            this.person = new PIXI.Sprite(PIXI.Texture.from('./images/Person/'+this.index+'.png'));
            this.person.width = this.person.width / 10;
            this.person.height = this.person.height / 10;
            this.person.x =this.x;
            this.person.y =this.y;
            this.person.anchor.set(0.5, 0.5);
            this.person.interactive = true;
            this.attracted=false

        }
        show(){
            app.stage.addChild(this.person);
        }
    }
    function Persongenerator(){
        if(Math.random()>0.5) {
            //上から出現
            x = 100+Math.random()*380
            y = 0
            vx=Math.random()-0.5
            vy=Math.random()
        }else{
            //下から出現
            x = Math.random()*380
            y = 285
            vx=Math.random()-0.5
            vy=-Math.random()
        }
        let person = new Passenger(x,y,vx,vy)
        person.show()
        personlist.push(person)
    }

    class cat{
        constructor(x,y,team) {

            this.max_stamp=35
            this.stamps=[]
            this.count_stamp=0
            this.speedcoeff=0.5
            this.sx=0
            this.sy=0
            this.x_0=0
            this.y_0=0
            this.footprint=false
            this.footwidth=5
            this.switchfooot=true

            this.x = x;
            this.y = y;
            this.texture00 = PIXI.Texture.from('./images/'+team+'/'+team+'_0.png');
            this.texture01 = PIXI.Texture.from('./images/'+team+'/'+team+'_1.png');
            this.texture10 = PIXI.Texture.from('./images/'+team+'/'+team+'0.png');
            this.texture11 = PIXI.Texture.from('./images/'+team+'/'+team+'1.png');

            this.sprite = new PIXI.Sprite(this.texture01);
            this.sprite.width=this.sprite.width/30;
            this.sprite.height=this.sprite.height/30;
            this.sprite.anchor.set(0.5,0.5);
            this.sprite.x = 200;
            this.sprite.y = 200;
            this.sprite.interactive = true;
            app.stage.addChild(this.sprite);
        }
        render(delta){
            this.px=this.sx
            this.py=this.sy
            this.dx=Math.abs(app.renderer.plugins.interaction.mouse.global.x-this.sprite.x)
            this.dy=Math.abs(app.renderer.plugins.interaction.mouse.global.y-this.sprite.y)

            this.sx=speed(app.renderer.plugins.interaction.mouse.global.x,this.sprite.x)
            this.sy=speed(app.renderer.plugins.interaction.mouse.global.y,this.sprite.y)
            if(this.sy==0&&this.sx==0&&this.sprite.texture==this.texture11){
                this.sprite.texture=this.texture10
            }

            if(this.sprite.y<this.sprite.height*0.8&&this.sy<0){
                this.sy=0
            }
            if(this.sprite.y>285&&this.sy>0){
                this.sy=0
            }
            if(this.sprite.x<this.sprite.width*0.6&&this.sx<0){
                this.sx=0
            }
            if(this.sprite.x>380&&this.sx>0){
                this.sx=0
            }

            if (this.sx<0){
                this.sprite.texture=this.switchfooot?this.texture00:this.texture01;
            } else if(this.sx>0){
                this.sprite.texture=this.switchfooot?this.texture10:this.texture11;
            }else if (this.sx==0&&(!(this.sy==0) )){
                this.sprite.texture=this.switchfooot?this.texture10:this.texture11;
            }

            if(this.sy==0&&this.sx==0&&this.sprite.texture==this.texture01){
                this.sprite.texture=this.texture00
            }
            if(this.sy==0&&this.sx==0&&this.sprite.texture==this.texture01){
                this.sprite.texture=this.texture00
            }



            this.sprite.x += this.sx*this.speedcoeff*delta;
            this.sprite.y +=this. sy*this.speedcoeff*delta;
            if(this.footprint) {
                if (Math.pow(Math.abs(this.sprite.x) - Math.abs(this.x_0), 2) + Math.pow(Math.abs(this.sprite.y) - Math.abs(this.y_0), 2) > this.footwidth*this.footwidth) {
                    this.count_stamp=this.count_stamp+1
                    switch (Math.abs(this.sx)>Math.abs(this.sy)){
                        case true:
                            if(this.sx>0){

                                this.a_stmap_sprite = new PIXI.Sprite(PIXI.Texture.from('./images/A/A_stamp_r.png'));
                            }else{
                               this. a_stmap_sprite = new PIXI.Sprite(PIXI.Texture.from('./images/A/A_stamp_l.png'));
                            }
                            break;
                        case false:
                            if(this.sy>0){
                                this.a_stmap_sprite = new PIXI.Sprite(PIXI.Texture.from('./images/A/A_stamp_d.png'));
                            }else{
                                this.a_stmap_sprite = new PIXI.Sprite(PIXI.Texture.from('./images/A/A_stamp_u.png'));
                            }
                            break;
                    }

                    this.a_stmap_sprite.width = this.sprite.width / 5;
                    this. a_stmap_sprite.height = this.sprite.height / 5;

                    this.a_stmap_sprite.anchor.set(Math.random()*this.switchfooot, -Math.random()*this.switchfooot);
                    this.a_stmap_sprite.x = this.sprite.x;
                    this.a_stmap_sprite.y = this.sprite.y;
                    app.stage.addChild(this.a_stmap_sprite);
                    this.a_stmap_sprite.anchor.set(Math.random()*!this.switchfooot, -Math.random()*!this.switchfooot);
                    this.a_stmap_sprite.x = this.sprite.x;
                    this.a_stmap_sprite.y = this.sprite.y+5;
                    app.stage.addChild(this.a_stmap_sprite);
                    app.stage.removeChild(this.sprite);
                    app.stage.addChild(this.sprite)
                    this.footprint=false
                    this.x_0=this.sprite.x
                    this.y_0=this.sprite.y
                    this.switchfooot=!this.switchfooot
                    this.stamps.push(this.a_stmap_sprite)
                    if(this.count_stamp>=this.max_stamp){
                        app.stage.removeChild(this.stamps.shift())
                    }
                }
            }else{
                if(this.sx || this.sy){
                    this.footprint=true
                }
            }
            //足跡距離更新
            if(Math.abs(Math.abs(this.sprite.x)-Math.abs(this.x_0))>this.footwidth){
                this.x_0=this.sprite.x
            }
            if(Math.abs(Math.abs(this.sprite.y)-Math.abs(this.y_0)>this.footwidth)){
                this.y_0=this.sprite.y
            }
        }
    }

    // Listen for animate update
    let kittle = new cat(10,150,'A')
    app.ticker.add((delta) => {
        for(j=0;j<personlist.length;j++){
            personlist[j].person.x+=personlist[j].vx*delta;
            personlist[j].person.y+=personlist[j].vy*delta;
        }

        kittle.render(delta)


    });

</script>
</body>
</html>